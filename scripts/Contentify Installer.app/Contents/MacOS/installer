#!/bin/bash
#
# Contentify One-Click Installer for macOS
# 
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞: Double-click –Ω–∞ .app –≤ Finder
# 
# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç:
# 1. –ö–æ–ø–∏—Ä—É–µ—Ç Extension (.crx) –∏–∑ –±–∞–Ω–¥–ª–∞
# 2. –°–∫–∞—á–∏–≤–∞–µ—Ç Relay –±–∏–Ω–∞—Ä–Ω–∏–∫ (–ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É)
# 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Native Messaging Host –¥–ª—è Chrome
# 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ Relay –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É
# 5. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç .crx –≤ Chrome –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
#

set -e

# === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
INSTALL_DIR="$HOME/.contentify"
RELEASE_URL="https://github.com/fusion-brisk/fluffy-chainsaw/releases/latest/download"
HOST_NAME="com.contentify.relay"
EXTENSION_ID="bkgihkkkahjfjpbplmcpggfnfkckhpnm"

# –ü—É—Ç—å –∫ —Ä–µ—Å—É—Ä—Å–∞–º –≤–Ω—É—Ç—Ä–∏ .app –±–∞–Ω–¥–ª–∞
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
RESOURCES_DIR="$(dirname "$SCRIPT_DIR")/Resources"

# === –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ===
run_installation() {
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "  üöÄ Contentify ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è macOS"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""

    # === –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ ===
    BINARY_NAME="contentify-relay-host-arm64"
    echo "üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: Apple Silicon (arm64)"
    echo ""

    # === –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ===
    echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
    mkdir -p "$INSTALL_DIR"
    echo "   ‚úì $INSTALL_DIR"
    echo ""

    # === –ö–æ–ø–∏—Ä—É–µ–º Extension (.crx) –∏–∑ –±–∞–Ω–¥–ª–∞ ===
    echo "üìÇ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è..."
    
    if [ -f "$RESOURCES_DIR/extension.crx" ]; then
      cp "$RESOURCES_DIR/extension.crx" "$INSTALL_DIR/extension.crx"
      echo "   ‚úì extension.crx —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"
    else
      echo "   ‚ö† extension.crx –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–Ω–¥–ª–µ"
      echo "   –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –∏–∑ GitHub..."
      
      cd "$INSTALL_DIR"
      if curl -L -s -f -o extension.crx "$RELEASE_URL/extension.crx" 2>/dev/null; then
        echo "   ‚úì extension.crx —Å–∫–∞—á–∞–Ω"
      else
        echo "   ‚úó –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å extension.crx"
        return 1
      fi
    fi
    echo ""

    # === –°–∫–∞—á–∏–≤–∞–µ–º Relay –±–∏–Ω–∞—Ä–Ω–∏–∫ ===
    echo "üì¶ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Relay..."
    cd "$INSTALL_DIR"
    
    echo -n "   $BINARY_NAME: "
    if curl -L -s -f -o relay-host "$RELEASE_URL/$BINARY_NAME" 2>/dev/null; then
      chmod +x relay-host
      echo "‚úì"
    else
      echo "‚úó"
      echo ""
      echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å $BINARY_NAME"
      echo "   URL: $RELEASE_URL/$BINARY_NAME"
      echo ""
      echo "   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
      echo "   ‚Ä¢ –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É"
      echo "   ‚Ä¢ GitHub Release –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω"
      echo ""
      return 1
    fi
    echo ""

    # === –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Native Messaging Host ===
    echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Native Messaging Host..."

    # Chrome
    CHROME_MANIFEST_DIR="$HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Google/Chrome" ]; then
      mkdir -p "$CHROME_MANIFEST_DIR"
      cat > "$CHROME_MANIFEST_DIR/$HOST_NAME.json" << EOF
{
  "name": "$HOST_NAME",
  "description": "Contentify Relay - connects Chrome Extension with Figma Plugin",
  "path": "$INSTALL_DIR/relay-host",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://$EXTENSION_ID/"
  ]
}
EOF
      echo "   ‚úì Chrome"
    fi

    # Chrome Canary
    CANARY_MANIFEST_DIR="$HOME/Library/Application Support/Google/Chrome Canary/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Google/Chrome Canary" ]; then
      mkdir -p "$CANARY_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$CANARY_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ‚úì Chrome Canary"
    fi

    # Chromium
    CHROMIUM_MANIFEST_DIR="$HOME/Library/Application Support/Chromium/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Chromium" ]; then
      mkdir -p "$CHROMIUM_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$CHROMIUM_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ‚úì Chromium"
    fi
    
    # Microsoft Edge
    EDGE_MANIFEST_DIR="$HOME/Library/Application Support/Microsoft Edge/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Microsoft Edge" ]; then
      mkdir -p "$EDGE_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$EDGE_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ‚úì Microsoft Edge"
    fi
    
    # Brave Browser
    BRAVE_MANIFEST_DIR="$HOME/Library/Application Support/BraveSoftware/Brave-Browser/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/BraveSoftware/Brave-Browser" ]; then
      mkdir -p "$BRAVE_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$BRAVE_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ‚úì Brave Browser"
    fi
    echo ""

    # === –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ LaunchAgent ===
    echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."

    LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
    mkdir -p "$LAUNCH_AGENTS_DIR"
    PLIST_PATH="$LAUNCH_AGENTS_DIR/$HOST_NAME.plist"

    cat > "$PLIST_PATH" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>$HOST_NAME</string>
    
    <key>ProgramArguments</key>
    <array>
        <string>$INSTALL_DIR/relay-host</string>
    </array>
    
    <key>RunAtLoad</key>
    <true/>
    
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    
    <key>StandardOutPath</key>
    <string>/tmp/contentify-relay.log</string>
    
    <key>StandardErrorPath</key>
    <string>/tmp/contentify-relay.err</string>
    
    <key>ProcessType</key>
    <string>Background</string>
</dict>
</plist>
EOF

    # –ó–∞–≥—Ä—É–∂–∞–µ–º LaunchAgent
    launchctl unload "$PLIST_PATH" 2>/dev/null || true
    launchctl load "$PLIST_PATH"
    echo "   ‚úì LaunchAgent —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""

    # === –ó–∞–ø—É—Å–∫–∞–µ–º Relay ===
    echo "üöÄ –ó–∞–ø—É—Å–∫ Relay —Å–µ—Ä–≤–µ—Ä–∞..."

    if lsof -i :3847 >/dev/null 2>&1; then
      echo "   ‚úì Relay —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3847"
    else
      launchctl start "$HOST_NAME" 2>/dev/null || true
      sleep 1
      if lsof -i :3847 >/dev/null 2>&1; then
        echo "   ‚úì Relay –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3847"
      else
        echo "   ‚ö† Relay –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É"
      fi
    fi
    echo ""

    # === –§–∏–Ω–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ ===
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Relay –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "üìå –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ Chrome:"
    echo ""
    echo "   –°–µ–π—á–∞—Å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è Chrome —Å .crx —Ñ–∞–π–ª–æ–º."
    echo ""
    echo "   1. –í–∫–ª—é—á–∏—Ç–µ 'Developer mode' (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É)"
    echo ""
    echo "   2. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ extension.crx –≤ –æ–∫–Ω–æ Chrome"
    echo "      –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'Load unpacked' ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É"
    echo ""
    echo "   3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è"
    echo ""
    echo "   4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Chrome"
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º Chrome –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
    if [ -d "/Applications/Google Chrome.app" ]; then
      open -a "Google Chrome" "chrome://extensions"
    elif [ -d "$HOME/Applications/Google Chrome.app" ]; then
      open -a "Google Chrome" "chrome://extensions"
    fi
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º Finder —Å .crx —Ñ–∞–π–ª–æ–º
    sleep 1
    open -R "$INSTALL_DIR/extension.crx"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º macOS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    osascript -e 'display notification "Relay —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost:3847. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ Chrome." with title "Contentify" subtitle "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚úì"' 2>/dev/null || true
    
    return 0
}

# === –ó–∞–ø—É—Å–∫ –≤ Terminal ===
SCRIPT_PATH="$0"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ –º—ã —É–∂–µ –≤ Terminal
if [ -z "$TERM_PROGRAM" ] || [ "$TERM_PROGRAM" != "Apple_Terminal" ]; then
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ–±—è –≤ Terminal
    osascript <<EOF
tell application "Terminal"
    activate
    do script "\"$SCRIPT_PATH\" --run-in-terminal; exit"
end tell
EOF
    exit 0
fi

# –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã —Å —Ñ–ª–∞–≥–æ–º --run-in-terminal, –≤—ã–ø–æ–ª–Ω—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
if [ "$1" = "--run-in-terminal" ]; then
    run_installation
    if [ $? -eq 0 ]; then
        echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞..."
        read
    else
        echo "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞..."
        read
        exit 1
    fi
else
    # –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ Terminal
    run_installation
fi
