#!/bin/bash
#
# EProductSnippet One-Click Installer for macOS
# 
# Установка: Double-click на .app в Finder
# 
# Что делает:
# 1. Копирует Extension (.crx) из бандла
# 2. Скачивает Relay бинарник (под архитектуру)
# 3. Устанавливает Native Messaging Host для Chrome
# 4. Настраивает автозапуск Relay при входе в систему
# 5. Открывает .crx в Chrome для установки
#

set -e

# === Конфигурация ===
INSTALL_DIR="$HOME/.eproductsnippet"
RELEASE_URL="https://github.com/fusion-brisk/fluffy-chainsaw/releases/latest/download"
HOST_NAME="com.eproductsnippet.relay"
EXTENSION_ID="bkgihkkkahjfjpbplmcpggfnfkckhpnm"

# Путь к ресурсам внутри .app бандла
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
RESOURCES_DIR="$(dirname "$SCRIPT_DIR")/Resources"

# === Функция установки ===
run_installation() {
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  🚀 EProductSnippet — Установка для macOS"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # === Определяем архитектуру ===
    ARCH=$(uname -m)
    if [ "$ARCH" = "arm64" ]; then
      BINARY_NAME="eproductsnippet-relay-host-arm64"
      echo "📱 Платформа: Apple Silicon (arm64)"
    else
      BINARY_NAME="eproductsnippet-relay-host-x64"
      echo "💻 Платформа: Intel (x64)"
    fi
    echo ""

    # === Создаём директорию установки ===
    echo "📁 Создание директории..."
    mkdir -p "$INSTALL_DIR"
    echo "   ✓ $INSTALL_DIR"
    echo ""

    # === Копируем Extension (.crx) из бандла ===
    echo "📂 Копирование расширения..."
    
    if [ -f "$RESOURCES_DIR/extension.crx" ]; then
      cp "$RESOURCES_DIR/extension.crx" "$INSTALL_DIR/extension.crx"
      echo "   ✓ extension.crx скопирован"
    else
      echo "   ⚠ extension.crx не найден в бандле"
      echo "   Попытка скачать из GitHub..."
      
      cd "$INSTALL_DIR"
      if curl -L -s -f -o extension.crx "$RELEASE_URL/extension.crx" 2>/dev/null; then
        echo "   ✓ extension.crx скачан"
      else
        echo "   ✗ Не удалось скачать extension.crx"
        return 1
      fi
    fi
    echo ""

    # === Скачиваем Relay бинарник ===
    echo "📦 Скачивание Relay..."
    cd "$INSTALL_DIR"
    
    echo -n "   $BINARY_NAME: "
    if curl -L -s -f -o relay-host "$RELEASE_URL/$BINARY_NAME" 2>/dev/null; then
      chmod +x relay-host
      echo "✓"
    else
      echo "✗"
      echo ""
      echo "❌ Ошибка: не удалось скачать $BINARY_NAME"
      echo "   URL: $RELEASE_URL/$BINARY_NAME"
      echo ""
      echo "   Возможные причины:"
      echo "   • Нет подключения к интернету"
      echo "   • GitHub Release ещё не создан"
      echo ""
      return 1
    fi
    echo ""

    # === Устанавливаем Native Messaging Host ===
    echo "🔧 Настройка Native Messaging Host..."

    # Chrome
    CHROME_MANIFEST_DIR="$HOME/Library/Application Support/Google/Chrome/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Google/Chrome" ]; then
      mkdir -p "$CHROME_MANIFEST_DIR"
      cat > "$CHROME_MANIFEST_DIR/$HOST_NAME.json" << EOF
{
  "name": "$HOST_NAME",
  "description": "EProductSnippet Relay - connects Chrome Extension with Figma Plugin",
  "path": "$INSTALL_DIR/relay-host",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://$EXTENSION_ID/"
  ]
}
EOF
      echo "   ✓ Chrome"
    fi

    # Chrome Canary
    CANARY_MANIFEST_DIR="$HOME/Library/Application Support/Google/Chrome Canary/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Google/Chrome Canary" ]; then
      mkdir -p "$CANARY_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$CANARY_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ✓ Chrome Canary"
    fi

    # Chromium
    CHROMIUM_MANIFEST_DIR="$HOME/Library/Application Support/Chromium/NativeMessagingHosts"
    if [ -d "$HOME/Library/Application Support/Chromium" ]; then
      mkdir -p "$CHROMIUM_MANIFEST_DIR"
      cp "$CHROME_MANIFEST_DIR/$HOST_NAME.json" "$CHROMIUM_MANIFEST_DIR/$HOST_NAME.json"
      echo "   ✓ Chromium"
    fi
    echo ""

    # === Настраиваем автозапуск через LaunchAgent ===
    echo "🔄 Настройка автозапуска..."

    LAUNCH_AGENTS_DIR="$HOME/Library/LaunchAgents"
    mkdir -p "$LAUNCH_AGENTS_DIR"
    PLIST_PATH="$LAUNCH_AGENTS_DIR/$HOST_NAME.plist"

    cat > "$PLIST_PATH" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>$HOST_NAME</string>
    
    <key>ProgramArguments</key>
    <array>
        <string>$INSTALL_DIR/relay-host</string>
    </array>
    
    <key>RunAtLoad</key>
    <true/>
    
    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
    </dict>
    
    <key>StandardOutPath</key>
    <string>/tmp/eproductsnippet-relay.log</string>
    
    <key>StandardErrorPath</key>
    <string>/tmp/eproductsnippet-relay.err</string>
    
    <key>ProcessType</key>
    <string>Background</string>
</dict>
</plist>
EOF

    # Загружаем LaunchAgent
    launchctl unload "$PLIST_PATH" 2>/dev/null || true
    launchctl load "$PLIST_PATH"
    echo "   ✓ LaunchAgent установлен"
    echo ""

    # === Запускаем Relay ===
    echo "🚀 Запуск Relay сервера..."

    if lsof -i :3847 >/dev/null 2>&1; then
      echo "   ✓ Relay уже работает на порту 3847"
    else
      launchctl start "$HOST_NAME" 2>/dev/null || true
      sleep 1
      if lsof -i :3847 >/dev/null 2>&1; then
        echo "   ✓ Relay запущен на порту 3847"
      else
        echo "   ⚠ Relay запустится при следующем входе в систему"
      fi
    fi
    echo ""

    # === Финальные инструкции ===
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "✅ Установка Relay завершена!"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "📌 Установка расширения в Chrome:"
    echo ""
    echo "   Сейчас откроется Chrome с .crx файлом."
    echo ""
    echo "   1. Включите 'Developer mode' (переключатель справа вверху)"
    echo ""
    echo "   2. Перетащите extension.crx в окно Chrome"
    echo "      или используйте 'Load unpacked' → выберите папку"
    echo ""
    echo "   3. Подтвердите установку расширения"
    echo ""
    echo "   4. Перезапустите Chrome"
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Открываем Chrome на странице расширений
    if [ -d "/Applications/Google Chrome.app" ]; then
      open -a "Google Chrome" "chrome://extensions"
    elif [ -d "$HOME/Applications/Google Chrome.app" ]; then
      open -a "Google Chrome" "chrome://extensions"
    fi
    
    # Открываем Finder с .crx файлом
    sleep 1
    open -R "$INSTALL_DIR/extension.crx"
    
    return 0
}

# === Запуск в Terminal ===
SCRIPT_PATH="$0"

# Проверяем, запущены ли мы уже в Terminal
if [ -z "$TERM_PROGRAM" ] || [ "$TERM_PROGRAM" != "Apple_Terminal" ]; then
    # Запускаем себя в Terminal
    osascript <<EOF
tell application "Terminal"
    activate
    do script "\"$SCRIPT_PATH\" --run-in-terminal; exit"
end tell
EOF
    exit 0
fi

# Если запущены с флагом --run-in-terminal, выполняем установку
if [ "$1" = "--run-in-terminal" ]; then
    run_installation
    if [ $? -eq 0 ]; then
        echo "Нажмите Enter для закрытия окна..."
        read
    else
        echo "Нажмите Enter для закрытия окна..."
        read
        exit 1
    fi
else
    # Прямой запуск из Terminal
    run_installation
fi
