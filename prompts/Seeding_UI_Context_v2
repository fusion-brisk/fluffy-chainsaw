# Contentify Plugin - Seeding Context v2

## ğŸ¯ Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ·Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
Figma-Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ **Contentify** Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ°ĞºĞµÑ‚Ğ¾Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ· HTML/MHTML Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² (Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ° Ğ¯Ğ½Ğ´ĞµĞºÑ-Ğ¿Ğ¾Ğ¸ÑĞºĞ°). ĞŸĞ°Ñ€ÑĞ¸Ñ‚ HTML â†’ Ğ¸Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ â†’ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Ğ² Figma.

---

## âš ï¸ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• ĞĞ“Ğ ĞĞĞ˜Ğ§Ğ•ĞĞ˜Ğ¯ (Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼ Ğ´ĞµĞ»Ğ¾Ğ¼!)

### 1. ES5 Ğ² code.js
```
code.ts ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² ES5 Ñ‡ĞµÑ€ĞµĞ· Babel. 
ĞĞ¸ĞºĞ°ĞºĞ¸Ñ…: async/await, arrow functions, spread, template literals Ğ² Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞœ ĞºĞ¾Ğ´Ğµ.
TypeScript Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ², Ğ½Ğµ Ğ´Ğ»Ñ Ñ€Ğ°Ğ½Ñ‚Ğ°Ğ¹Ğ¼Ğ°.
```

### 2. ĞĞµÑ‚ Node.js API
```
Ğ’ code.js Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ¢ĞĞ›Ğ¬ĞšĞ:
- Figma Plugin API (figma.*)
- Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ½Ñ‹Ğµ API (fetch, Ğ½Ğ¾ Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸)
- ES5 JavaScript
```

### 3. ĞšĞ¾Ğ¼Ğ¼ÑƒĞ½Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· postMessage
```typescript
// UI â†’ Plugin
parent.postMessage({ pluginMessage: { type: 'import-csv', rows, scope } }, '*');

// Plugin â†’ UI  
figma.ui.postMessage({ type: 'progress', current, total });
```

---

## ğŸ“ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

```
src/
â”œâ”€â”€ code.ts              # Figma plugin backend (ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»Ğ¸Ñ‚ÑÑ Ğ² ES5!)
â”œâ”€â”€ ui.tsx               # React 18 UI (state machine)
â”œâ”€â”€ ui.html              # ĞšĞ°Ñ€ĞºĞ°Ñ UI
â”œâ”€â”€ styles.css           # Figma UI3 ÑÑ‚Ğ¸Ğ»Ğ¸ (CSS variables)
â”œâ”€â”€ types.ts             # TypeScript Ñ‚Ğ¸Ğ¿Ñ‹
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Header.tsx           # ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ header Ñ SVG-Ğ¸ĞºĞ¾Ğ½ĞºĞ°Ğ¼Ğ¸ Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸
â”‚   â”œâ”€â”€ ScopeControl.tsx     # Selection/Page toggle + hint
â”‚   â”œâ”€â”€ DropZone.tsx         # Drag&drop Ñ progress overlay
â”‚   â””â”€â”€ import/
â”‚       â”œâ”€â”€ LiveProgressView.tsx  # GPT-style thinking ÑÑ‚Ğ°Ñ‚ÑƒÑ
â”‚       â”œâ”€â”€ CompletionCard.tsx    # Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ ĞºÑ€ĞµÑÑ‚Ğ¸ĞºĞ¾Ğ¼
â”‚       â””â”€â”€ ErrorCard.tsx         # ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°/Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
â”‚
â””â”€â”€ utils/
    â”œâ”€â”€ plugin-bridge.ts     # sendMessageToPlugin helper
    â”œâ”€â”€ mhtml-parser.ts      # ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ MHTML
    â””â”€â”€ snippet-parser.ts    # ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ HTML Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸
```

---

## ğŸ”„ UI State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        IDLE          â”‚
                    â”‚  DropZone Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½    â”‚
                    â”‚  ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½ Tip Ğ¸Ğ»Ğ¸     â”‚
                    â”‚  lastError Ğ¸Ğ»Ğ¸       â”‚
                    â”‚  lastCompletionStats â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ Drop file
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚       LOADING        â”‚
                    â”‚  DropZone disabled   â”‚
                    â”‚  Progress overlay    â”‚
                    â”‚  LiveProgressView    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ error          â”‚ done           â”‚
              â–¼                â–¼                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚   IDLE + Error  â”‚ â”‚ IDLE + Completion   â”‚ â”‚
    â”‚   ErrorCard     â”‚ â”‚ CompletionCard      â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚                â”‚                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         Ã— Dismiss â†’ IDLE + Tip
```

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ² ui.tsx:
```typescript
const [isLoading, setIsLoading] = useState(false);
const [lastError, setLastError] = useState<{message: string; details?: string} | null>(null);
const [lastCompletionStats, setLastCompletionStats] = useState<{
  stats: ProcessingStats;
  processingTime: number | null;
} | null>(null);

// Ğ’ĞĞ–ĞĞ: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ref Ğ´Ğ»Ñ stats Ğ¸Ğ·-Ğ·Ğ° closure Ğ² message handler!
const statsRef = useRef<ProcessingStats | null>(null);
```

---

## ğŸ¨ Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½-ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°

### Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¿Ğ°Ğ»Ğ¸Ñ‚Ñ€Ğ° (Discord-inspired)
```css
--figma-color-bg: #1a1a1a;
--figma-color-bg-brand: #5865F2;        /* Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹ accent */
--figma-color-text-success: #23A55A;    /* Ğ—ĞµĞ»Ñ‘Ğ½Ñ‹Ğ¹ */
--figma-color-text-danger: #F23F43;     /* ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ */
--gradient-brand: linear-gradient(135deg, #5865F2, #7B68EE);
```

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ UI Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:
1. **Header** â€” Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ 32Ã—32, Ğ±ĞµĞ· Ñ„Ğ¾Ğ½Ğ°
2. **DropZone** â€” Ñ glow-ÑÑ„Ñ„ĞµĞºÑ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸ hover, progress bar Ğ²Ğ½Ğ¸Ğ·Ñƒ
3. **Status cards** â€” Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ Ñ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸ĞµĞ¹, ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ã— Ğ´Ğ»Ñ dismiss
4. **Thinking status** â€” Ğ°Ğ½Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ñ‡ĞºĞ¸ + ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸

---

## ğŸ› Ğ˜Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ gotchas

### 1. Closure Ğ² message handler
```typescript
// ĞĞ•ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - stats Ğ±ÑƒĞ´ĞµÑ‚ stale!
else if (msg.type === 'done') {
  if (stats) { // â† stats Ğ¸Ğ· closure, Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ null
    setLastCompletionStats({ stats, ... });
  }
}

// ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ref
statsRef.current = msg.stats; // Ğ² stats handler
const currentStats = statsRef.current; // Ğ² done handler
```

### 2. SVG Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Ğ±ĞµĞ· ÑÑ‚Ğ¸Ğ»ĞµĞ¹ = Ğ¾Ğ³Ñ€Ğ¾Ğ¼Ğ½Ñ‹Ğµ
```tsx
// ĞĞ•ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ
<svg className="icon-svg" ...> // ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ ÑÑ‚Ğ¸Ğ»ĞµĞ¹ - Ğ±ÑƒĞ´ĞµÑ‚ Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½

// ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ - ÑĞ²Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹
<svg width="16" height="16" viewBox="0 0 16 16" ...>
```

### 3. DropZone Ğ²ÑĞµĞ³Ğ´Ğ° Ğ²Ğ¸Ğ´ĞµĞ½
```tsx
// DropZone ĞĞ• ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ loading, Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ disabled
<DropZone
  isLoading={isLoading}  // Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ progress overlay
  disabled={isLoading}   // Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
  progress={progress}    // Ğ´Ğ»Ñ progress bar
/>
```

### 4. Error Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ½Ğ°Ğ´ Completion
```tsx
{!isLoading && lastError && <ErrorCard ... />}
{!isLoading && !lastError && lastCompletionStats && <CompletionCard ... />}
{!isLoading && !lastError && !lastCompletionStats && <Tip />}
```

---

## ğŸ“¨ Ğ¢Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

### UI â†’ Plugin
```typescript
| { type: 'import-csv'; rows: CSVRow[]; scope: 'selection' | 'page' }
| { type: 'get-settings' }
| { type: 'save-settings'; settings: UserSettings }
| { type: 'get-parsing-rules' }
| { type: 'check-remote-rules-update' }
```

### Plugin â†’ UI
```typescript
| { type: 'progress'; current: number; total: number; operationType?: string }
| { type: 'stats'; stats: ProcessingStats }
| { type: 'done'; count: number }
| { type: 'log'; message: string }
| { type: 'error'; message: string }
| { type: 'selection-status'; hasSelection: boolean }
```

---

## ğŸ— Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°

```bash
npm run build
# = rollup -c && node add-polyfill.js && node embed-ui.js

# Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:
# dist/code.js           - ES5 backend
# dist/ui-embedded.html  - React UI Ñ Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑÑ‚Ğ¸Ğ»ÑĞ¼Ğ¸
```

**add-polyfill.js** â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ğ¾Ğ»Ğ¸Ñ„Ğ¸Ğ»Ğ» Promise Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ code.js
**embed-ui.js** â€” Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½Ğ¸Ñ‚ CSS Ğ² HTML

---

## âœ… Ğ§Ñ‚Ğ¾ ÑƒĞ¶Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ (v2)

1. âœ… Drag&drop HTML/MHTML Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
2. âœ… ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¯Ğ½Ğ´ĞµĞºÑ-Ğ²Ñ‹Ğ´Ğ°Ñ‡Ğ¸ (snippet-parser.ts)
3. âœ… Progress overlay Ğ² DropZone
4. âœ… GPT-style thinking ÑÑ‚Ğ°Ñ‚ÑƒÑ (LiveProgressView)
5. âœ… Completion card Ñ dismiss
6. âœ… Error card Ñ dismiss
7. âœ… ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ header Ñ SVG-Ğ¸ĞºĞ¾Ğ½ĞºĞ°Ğ¼Ğ¸
8. âœ… Scope control (Selection/Page)
9. âœ… Parsing rules viewer Ğ² Settings
10. âœ… Remote config update
11. âœ… Logs view Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸

---

## ğŸ¯ ĞŸÑ€Ğ¸ Ğ²Ğ½ĞµÑĞµĞ½Ğ¸Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

1. **Ğ¡Ñ‚Ğ¸Ğ»Ğ¸** â€” Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞ¹ `src/styles.css`, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ CSS variables
2. **ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹** â€” Ğ² `src/components/`, React + TypeScript
3. **Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°** â€” `src/code.ts`, Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ Ğ¿Ñ€Ğ¾ ES5!
4. **Ğ¢Ğ¸Ğ¿Ñ‹** â€” `src/types.ts`
5. **ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹** â€” `npm run build` Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ² Figma

