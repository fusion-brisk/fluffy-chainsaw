# Контекст: Тестирование EShopItem и LabelDiscount

## Цель
Проверить исправления логики кнопок EShopItem и разобраться с ошибкой отображения скидки `+24%`.

---

## Эффективные методы работы с тестовыми HTML-файлами

Файлы `examples/*.html` большие (1.7-2.2MB) и минифицированы (всё в одну строку). **НЕ используй Read** для них — файл не поместится в контекст.

### Рекомендуемые команды

```bash
# Размер и начало файла
ls -lh examples/kitfort595_offers.html && head -c 3000 examples/kitfort595_offers.html

# Подсчёт элементов по классу
grep -o 'EShopItem[^"]*' examples/kitfort595_offers.html | sort | uniq -c | head -20

# Подсчёт типов кнопок
grep -o 'Button_view_[a-zA-Z]*' examples/kitfort595_offers.html | sort | uniq -c

# Поиск HTML-элементов (разбиваем по '>' для читаемости)
cat examples/kitfort595_offers.html | tr '>' '\n' | grep 'EShopItem_withCheckout' | head -5

# Контекст вокруг паттерна
cat examples/kitfort595_offers.html | tr '>' '\n' | grep -A5 'EMarketCheckoutButton' | head -20

# Поиск конкретных классов в элементах
cat examples/kitfort595_offers.html | tr '>' '\n' | grep -E '<li[^<]*EShopItem' | head -10
```

### Figma MCP
Для проверки результатов в Figma используй:
- `get_screenshot` — скриншот выбранного фрейма
- `get_metadata` — XML-структура фрейма (ID, имена, позиции)
- `get_design_context` — детальный контекст для реализации

---

## Что было сделано в предыдущем чате

### 1. Анализ тестовых файлов

**kitfort595.html** (2.2MB) — страница поиска "пылесос kitfort kt-595":
- Organic сниппеты с MarketCheckout
- EProductSnippet2 карточки
- **Нет EOfferItem/EShopItem** в DOM (грузятся динамически)
- Button_view_primary: 7, Button_view_default: 17

**kitfort595_offers.html** (1.7MB) — вкладка "Товары":
- **21 EShopItem** — карточки магазинов
- **2 EShopItem_withCheckout** — с красной кнопкой чекаута
- **19 EShopItem без чекаута** — с обычной ссылкой "В магазин"
- Button_view_primary: 5, Button_view_default: 33

### 2. Исправлена логика кнопок EShopItem

**Проблема**: Все 21 EShopItem показывали кнопку, хотя только 2 должны.

**Причина**: `Button_view_default` (ссылка "В магазин") есть у всех EShopItem, и парсер считал это кнопкой.

**Исправление** в `src/utils/snippet-parser.ts` (строки ~997-1003):

```typescript
// БЫЛО:
const hasAnyButton = hasCheckoutButton || hasWhiteButton || hasDefaultButton;

// СТАЛО:
const hasAnyButton = snippetType === 'EShopItem' 
  ? hasCheckoutButton  // EShopItem: ТОЛЬКО checkout кнопка
  : (hasCheckoutButton || hasWhiteButton || hasDefaultButton);
```

**Логика определения кнопок по типам сниппетов:**

| Тип сниппета | Условие показа кнопки | ButtonView |
|--------------|----------------------|------------|
| **EShopItem** | `EShopItem_withCheckout` или `EMarketCheckoutButton` | `primaryShort` |
| **EOfferItem** | Красная кнопка (Button_view_primary) | `primaryShort` |
| **EOfferItem** | Белая кнопка (Button_view_white) | `white` |
| **ESnippet/Organic** | `MarketCheckout-Button` или `data-market-url-type="market_checkout"` | `primaryShort` + `visible=true` |

### 3. Обнаружена проблема с лейблом скидки

На скриншоте Figma видно: `15 277₽ +24%` — знак **плюс** вместо минуса.

**Гипотезы**:
1. EPriceBarometer показывает "цена выше рынка на X%" (не скидка!)
2. Неправильный маппинг поля скидки на текстовый слой
3. Ошибка в regex извлечения скидки

**Regex для скидки** (`src/utils/regex.ts`):
```typescript
export const DISCOUNT_PERCENT_REGEX = /([\d,]+)\s*%/;
export const DISCOUNT_VALUE_REGEX = /([\d\s\u2009\u00A0,]+)/;
```

---

## Изменённые файлы

1. **src/utils/snippet-parser.ts**
   - Строки ~997-1010: исправлена логика `hasAnyButton` для EShopItem
   - EShopItem теперь показывает кнопку только с модификатором `_withCheckout`

---

## Сборка

```bash
npm run build  # ✅ Успешно
```

---

## Что нужно проверить

### 1. Кнопки EShopItem ✅ (исправлено, нужно протестировать)
После исправления:
- **2 EShopItem** должны показывать красную кнопку "Купить в 1 клик"
- **19 EShopItem** должны быть **без кнопки**

### 2. Лейбл скидки `+24%` ❓ (нужно исследовать)
Определить:
- Это поле `LabelDiscount` или `EPriceBarometer`?
- Откуда берётся значение `+24%`?
- Какой компонент в Figma отображает этот текст?

Команды для исследования:
```bash
# Найти паттерны скидок в HTML
grep -o '[-−–+][0-9]*%' examples/kitfort595_offers.html | sort | uniq -c

# Найти LabelDiscount элементы
cat examples/kitfort595_offers.html | tr '>' '\n' | grep 'LabelDiscount' | head -10

# Найти EPriceBarometer
cat examples/kitfort595_offers.html | tr '>' '\n' | grep 'Barometer' | head -10
```

---

## HTML-структура (для справки)

### EShopItem с чекаутом (должна быть кнопка)
```html
<li class="EShopItem EShopItem_ugcRedesign EShopItem_withCheckout ProductsTiles-ShopItem">
  <div class="EMarketCheckoutButton-Container">
    <a class="Button Button_view_primary EMarketCheckoutButton-Button" 
       href="https://market.yandex.ru/my/cart?...">
```

### EShopItem без чекаута (кнопки НЕ должно быть)
```html
<li class="EShopItem EShopItem_ugcRedesign ProductsTiles-ShopItem">
  <div class="EShopItem-ButtonContainer">
    <button class="Button Button_view_default EShopItem-Button">
```

### Красная кнопка чекаута (MarketCheckout)
```html
<a data-market-url-type="market_checkout" 
   class="Button Button_view_primary EMarketCheckoutButton-Button"
   href="https://market.yandex.ru/my/cart?..." или "https://checkout.kit.yandex.ru/express?...">
```

---

## Ключевые файлы кодовой базы

| Файл | Назначение |
|------|------------|
| `src/utils/snippet-parser.ts` | Парсинг HTML → CSVRow (логика кнопок ~строки 940-1050) |
| `src/component-handlers.ts` | Обработчики Figma компонентов (handleEButton, handleEPriceGroup) |
| `src/parsing-rules.ts` | Правила парсинга (v6), селекторы DOM |
| `src/utils/regex.ts` | Скомпилированные регулярки |
| `config/parsing-rules.json` | JSON версия правил парсинга |

---

## Тестовые файлы

| Файл | Содержимое |
|------|------------|
| `examples/kitfort595.html` | Organic с MarketCheckout (основная выдача) |
| `examples/kitfort595_offers.html` | EShopItem: 21 шт, 2 с чекаутом (вкладка "Товары") |
| `examples/iphone17.html` | Другой тестовый запрос |

---

## Предыдущие контексты

- `prompts/EButton_Testing_Context` — контекст по логике кнопок EButton (v1)
- `prompts/MarketCheckoutButton_Context` — контекст по MarketCheckout
