# Backend Audit: code.ts & component-handlers.ts

## Контекст

Ты — senior Figma Plugin developer. Мы рефакторим плагин "EProductSnippet" (бывш. Contentify).

**Уже сделано (UI-рефакторинг):**
- Удалены 6 неиспользуемых файлов (5 компонентов + 1 CSS)
- Типизирован протокол сообщений UI↔Code (types.ts)
- Создан хук `usePluginMessages.ts` для обработки сообщений
- Вынесены константы в `config.ts` (PROCESSING_TIPS, STAGE_LABELS)
- Удалён мёртвый CSS, исправлены ESLint ошибки
- Сборка чистая: Rollup + Babel → ES5

## Цель этого чата

Провести аудит и рефакторинг **backend-логики** плагина:
1. `src/code.ts` — 1129 строк (главная точка входа)
2. `src/component-handlers.ts` — 1962 строки (обработчики компонентов)

## Задачи

### 1. Аудит code.ts
- [ ] Проверить структуру и выделить логические блоки
- [ ] Найти дублирование кода
- [ ] Проверить error handling (консистентность)
- [ ] Оценить возможность декомпозиции

### 2. Аудит component-handlers.ts
- [ ] Это самый большой файл (1962 строки) — нужна декомпозиция
- [ ] Найти паттерны, которые можно обобщить
- [ ] Проверить типизацию
- [ ] Выделить группы handlers по назначению

### 3. Предложить план рефакторинга
- [ ] Какие модули выделить
- [ ] Какие абстракции создать
- [ ] Приоритезировать по риску и эффекту

## Ограничения (КРИТИЧНО)

1. **ES5 на выходе** — код транспилируется Babel до ES5
2. **Никаких Node.js API** — только Figma Plugin API + ES5
3. **Совместимость с Figma Sandbox** — ограниченное окружение
4. **Не ломать существующий функционал** — инкрементальные изменения

## Структура проекта

```
src/
├── code.ts                  ← ГЛАВНЫЙ ФАЙЛ (точка входа плагина)
├── component-handlers.ts    ← САМЫЙ БОЛЬШОЙ ФАЙЛ
├── config.ts                ← Конфигурация
├── types.ts                 ← Типы (UIMessage, CodeMessage, etc.)
├── logger.ts
├── image-handlers.ts
├── text-handlers.ts
├── property-utils.ts
├── parsing-rules.ts
├── parsing-rules-manager.ts
└── utils/                   ← UI-утилиты (не трогаем)
```

## Формат работы

1. Сначала прочитай оба файла целиком
2. Составь карту функций/классов
3. Найди проблемные места (дублирование, сложность, типы)
4. Предложи план декомпозиции с оценкой рисков
5. Реализуй изменения этапами, после каждого — проверка сборки

## Начни с

```
Прочитай src/code.ts и src/component-handlers.ts, 
составь карту структуры и выведи:
1. Список функций/классов с кратким описанием
2. Зависимости между ними
3. Топ-5 проблемных мест (по сложности/дублированию)
4. Предложение по группировке для декомпозиции
```

