# –ö–æ–Ω—Ç–µ–∫—Å—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ relay:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –ø–æ –∏–∫–æ–Ω–∫–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ relay
2. –ü–ª–∞–≥–∏–Ω Figma –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ auto-polling (RelayIndicator)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è "–°–æ–∑–¥–∞—Ç—å –∞—Ä—Ç–±–æ—Ä–¥?"
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å"
5. **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ç–∏—á–Ω—ã–º
6. –ü–ª–∞–≥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ UI –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –§–∞–π–ª—ã UI
- `src/ui.tsx` ‚Äî –≥–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç App
- `src/components/RelayIndicator.tsx` ‚Äî –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤—è–∑–∏ —Å relay (auto-polling)
- `src/components/ImportConfirmDialog.tsx` ‚Äî –¥–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞
- `src/components/DropZone.tsx` ‚Äî –∑–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ + –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
- `src/hooks/usePluginMessages.ts` ‚Äî —Ö—É–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–ª–∞–≥–∏–Ω–∞

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –∏–∑ relay

```
RelayIndicator (polling) 
    ‚Üì onDataReceived(payload, query)
App.handleRelayDataReceived
    ‚Üì setPendingRelayData({...})
ImportConfirmDialog –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è
    ‚Üì onConfirm
App.handleConfirmRelayImport
    ‚Üì sendMessageToPlugin({ type: 'apply-relay-payload', payload })
    ‚Üì setIsLoading(true), setProgress({...})
code.ts –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 'apply-relay-payload'
    ‚Üì figma.ui.postMessage({ type: 'relay-payload-applied', ... })
usePluginMessages –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç
    ‚Üì –ù–û: –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!
```

### –ö–ª—é—á–µ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ usePluginMessages.ts

```typescript
// src/hooks/usePluginMessages.ts
export interface PluginMessageHandlers {
  // ... –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  onDone?: (count: number, elapsedTime?: number) => void;
  onProgress?: (progress: ProgressData) => void;
  onBuildPageDone?: (count: number, frameName: string) => void;
  // relay-payload-applied ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è?
}
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ ui.tsx

```typescript
// handleConfirmRelayImport ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–ª–∞–≥–∏–Ω
const handleConfirmRelayImport = useCallback(() => {
  // ...
  setIsLoading(true);
  setUiState('loading');
  setProgress({ current: 0, total: 100, message: '–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–±–æ—Ä–¥–∞...' });
  // ...
  sendMessageToPlugin({ 
    type: 'apply-relay-payload', 
    payload: pendingRelayData.payload 
  });
}, [pendingRelayData, addLog]);
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ code.ts

```typescript
// code.ts ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 'apply-relay-payload'
if (msg.type === 'apply-relay-payload') {
  // ... —Å–æ–∑–¥–∞—ë—Ç SERP —Å—Ç—Ä–∞–Ω–∏—Ü—É
  figma.ui.postMessage({
    type: 'relay-payload-applied',
    success: result.success,
    itemCount: result.createdCount,
    frameName: result.frame?.name
  });
}
```

## –ó–∞–¥–∞—á–∞

1. –ù–∞–π—Ç–∏ –ø–æ—á–µ–º—É UI –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ `relay-payload-applied`
2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `usePluginMessages.ts` –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
3. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞:
   - `setIsLoading(false)`
   - `setProgress(null)` –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å 100%
   - `setLastCompletionStats({...})` –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—Å–ø–µ—Ö–∞
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å confetti üéâ

## –î–∏–∞–≥–Ω–æ–∑

**–ü—Ä–∏—á–∏–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞:** –í `usePluginMessages.ts` **–ù–ï–¢ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞** –¥–ª—è —Ç–∏–ø–∞ `relay-payload-applied`!

–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ code.ts (—Å—Ç—Ä–æ–∫–∏ 189, 204), –Ω–æ UI –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ usePluginMessages.ts

```typescript
// –í interface PluginMessageHandlers –¥–æ–±–∞–≤–∏—Ç—å:
onRelayPayloadApplied?: (data: { success: boolean; itemCount?: number; frameName?: string; error?: string }) => void;

// –í switch –¥–æ–±–∞–≤–∏—Ç—å case:
case 'relay-payload-applied':
  if (h.onRelayPayloadApplied) {
    h.onRelayPayloadApplied({
      success: msg.success,
      itemCount: msg.itemCount,
      frameName: msg.frameName,
      error: msg.error
    });
  }
  break;
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ ui.tsx (messageHandlers)

```typescript
onRelayPayloadApplied: ({ success, itemCount, frameName, error }) => {
  const elapsedTime = processingStartTime ? Date.now() - processingStartTime : null;
  
  if (success) {
    addLog(`‚úÖ –°–æ–∑–¥–∞–Ω —Ñ—Ä–µ–π–º "${frameName}" —Å ${itemCount} —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏`);
    
    setLastCompletionStats({
      stats: {
        processedInstances: itemCount || 0,
        totalInstances: itemCount || 0,
        successfulImages: 0,
        skippedImages: 0,
        failedImages: 0,
      },
      processingTime: elapsedTime
    });
    
    setConfetti({ active: true, type: 'success' });
  } else {
    addLog(`‚ùå –û—à–∏–±–∫–∞: ${error}`);
    setLastError({ message: error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' });
  }
  
  setIsLoading(false);
  setUiState('idle');
  setProgress(null);
}
```

## –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è

1. `src/hooks/usePluginMessages.ts`:
   - –î–æ–±–∞–≤–∏—Ç—å `onRelayPayloadApplied` –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
   - –î–æ–±–∞–≤–∏—Ç—å case –≤ switch
   
2. `src/ui.tsx`:
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –æ–±—ä–µ–∫—Ç `messageHandlers`

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
2. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ç–±–æ—Ä–¥–∞
3. –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–æ–ª–∂–µ–Ω –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å—Å—è (–∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è)
4. –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É —É—Å–ø–µ—Ö–∞ –∏ confetti üéâ
