# Продолжение рефакторинга Contentify Plugin — Phase 5+

## Контекст

Мы проводим архитектурный рефакторинг Figma-плагина Contentify (EProductSnippet).
Завершены Phase 2-4, плагин собирается и работает.

## Завершённые фазы

### Phase 2: Декомпозиция code.ts ✅
- `src/code.ts`: 1163 → 129 строк (entry-point)
- Новые модули в `src/plugin/`:
  - `types.ts` — типы CSVRow, ProgressCallback, ContainerRowAssignment
  - `message-router.ts` — роутинг postMessage событий
  - `global-handlers.ts` — resetAllSnippets, applyGlobalQuery
  - `data-assignment.ts` — маппинг rows → containers
  - `snippet-processor.ts` — основной цикл import-csv
  - `index.ts` — реэкспорт

### Phase 3: Унификация handlers ✅
- Новые модули в `src/handlers/`:
  - `registry.ts` — Handler Registry с приоритетами (CRITICAL=0, VARIANTS=10, VISIBILITY=20, TEXT=30, FALLBACK=40)
  - `field-fallbacks.ts` — декларативные fallback chains (#OrganicText ← #OrganicTitle, #OrganicHost ← #ShopName)
  - `types.ts` — HandlerResult, HandlerMetadata, RegisteredHandler

### Phase 4: Типизация данных ✅
- Новые модули в `src/types/`:
  - `csv-fields.ts` — CSVFields интерфейс с ~40 типизированными полями, SnippetType, REQUIRED_FIELDS, IMAGE_FIELDS, BOOLEAN_FIELDS
  - `field-mapping.ts` — JSON-конфиг маппинга полей → Figma layers, FIELD_MAPPINGS, getMappingForComponent
  - `validation.ts` — validateRow, validateRows, hasRequiredFields, нормализация булевых/числовых значений
  - `index.ts` — реэкспорт

## Текущая структура кода

```
src/
├── code.ts (129 строк) — entry-point
├── plugin/
│   ├── types.ts
│   ├── message-router.ts
│   ├── global-handlers.ts
│   ├── data-assignment.ts
│   ├── snippet-processor.ts
│   └── index.ts
├── handlers/
│   ├── types.ts (HandlerContext, HandlerResult, etc.)
│   ├── registry.ts (handlerRegistry, HandlerPriority)
│   ├── field-fallbacks.ts (applyFieldFallbacks, FIELD_FALLBACKS)
│   ├── button-handlers.ts
│   ├── label-handlers.ts
│   ├── price-handlers.ts
│   ├── delivery-handlers.ts
│   └── snippet-handlers.ts
├── types/
│   ├── csv-fields.ts (CSVFields, SnippetType, REQUIRED_FIELDS)
│   ├── field-mapping.ts (FIELD_MAPPINGS, ComponentMappingGroup)
│   ├── validation.ts (validateRow, validateRows)
│   └── index.ts
├── types.ts — основной файл типов (реэкспортирует из types/)
├── component-handlers.ts — реэкспорт всех handlers
├── image-handlers.ts
├── text-handlers.ts
├── config.ts
├── logger.ts
└── utils/ — UI утилиты (парсинг HTML, DOM cache, etc.)
```

## Что ещё можно улучшить (опционально)

### Phase 5: Интеграция registry в snippet-processor ✅
- snippet-processor.ts теперь использует `handlerRegistry.executeAll(context)`
- Удалены прямые вызовы 15+ handlers
- Добавлено логирование HandlerResult[]
- Сборка успешна

### Phase 6: Миграция на StrictCSVRow ✅
- Унифицированы все CSVRow на типизированный из `types/csv-fields.ts`
- Type-safe доступ к полям, автокомплит, compile-time проверки
- Сборка успешна

### Phase 7: Unit-тесты для handlers ✅
- Vitest + моки Figma API
- 45 тестов: field-fallbacks, validation, registry
- `npm run test` / `npm run test:watch`

### Phase 8: Потоковая обработка MHTML ✅
- Streaming parser без `split()` — итеративный indexOf + substring
- Async версия с yield в event loop
- Прогресс-коллбэк для UI
- 13 новых тестов (58 всего)

## Команды

```bash
cd /Users/shchuchkin/Documents/GitHub/fluffy-chainsaw
npm run build  # Сборка
npm run lint   # Проверка ESLint
```

## Правила (из .cursorrules)
- ES5 target для code.js (Figma Plugin API)
- Никаких Node.js API в рантайме плагина
- UI собирается отдельно (ui.tsx → ui.html)
- Логирование обязательно
- При изменениях ui.html — отдавать полный файл

## Начало работы

1. Прочитай `src/plugin/snippet-processor.ts` — основной цикл
2. Прочитай `src/handlers/registry.ts` — registry архитектура
3. Прочитай `src/types/csv-fields.ts` — типы данных
4. Выбери задачу из Phase 5-8 или предложи свою

Сборка работает, плагин функционирует.

