# Контекст: Тестирование логики EButton

## Цель
Проверить работу логики кнопок на реальных HTML-файлах Яндекс-выдачи.

---

## Что было сделано в предыдущем чате

### 1. Парсинг типа кнопки (snippet-parser.ts)

Добавлена логика определения `#ButtonView` для разных типов сниппетов:

| Тип сниппета | Красная кнопка чекаута | Белая/Дефолтная кнопка |
|--------------|------------------------|------------------------|
| **EOfferItem** | `ButtonView='primaryShort'` | `ButtonView='white'` |
| **EShopItem** | `ButtonView='primaryShort'` | `ButtonView='secondary'` |
| **ESnippet/Organic** | `ButtonView='primaryShort'` + `EButton_visible='true'` | `EButton_visible='false'` |

### 2. Обработчик handleEButton() (component-handlers.ts)

```typescript
// Логика:
// - EOfferItem/EShopItem: устанавливает view property на EButton
// - ESnippet/Organic: управляет visible + view
```

### 3. Новые селекторы в parsing-rules.ts (v6)

```typescript
'Button_view_white': {
    domSelectors: ['.Button_view_white', '[class*="Button_view_white"]']
}
'Button_view_default': {
    domSelectors: ['.Button_view_default', '[class*="Button_view_default"]']
}
'Button_view_primary': {
    domSelectors: ['.Button_view_primary', '[class*="Button_view_primary"]']
}
```

---

## Изменённые файлы

1. **src/parsing-rules.ts** (v6)
   - Добавлены селекторы Button_view_white, Button_view_default, Button_view_primary

2. **src/utils/snippet-parser.ts**
   - Полностью переписана логика #BUTTON и добавлено #ButtonView
   - Обновлена секция EOfferItem с определением типа кнопки

3. **src/component-handlers.ts**
   - Добавлен handleEButton() для управления EButton в Figma
   - Вспомогательные функции handleButtonInstance() и setButtonView()

4. **src/code.ts**
   - Добавлен импорт и вызов handleEButton()

5. **config/parsing-rules.json** (v6)
   - Синхронизирован с TypeScript версией

6. **src/utils/dom-utils.ts**
   - Добавлен .EOfferItem в findSnippetContainers()
   - Добавлены селекторы для extractProductURL() из EOfferItem

---

## Новые поля в CSVRow

| Поле | Значения | Описание |
|------|----------|----------|
| `#BUTTON` | `true`, `false` | Наличие кнопки |
| `#ButtonView` | `primaryShort`, `white`, `secondary` | Вид кнопки для Figma EButton |
| `#ButtonType` | `checkout`, `shop` | Тип кнопки (для EOfferItem) |
| `#EButton_visible` | `true`, `false` | Видимость EButton (для ESnippet) |

---

## Сборка

```bash
npm run build  # ✅ Успешно
```

---

## Что нужно проверить

1. **EOfferItem** (попап "Цены в магазинах"):
   - Красная кнопка чекаута → `ButtonView='primaryShort'`
   - Белая кнопка "В магазин" → `ButtonView='white'`

2. **EShopItem** (вкладка "Товары"):
   - Красная кнопка EMarketCheckoutButton → `ButtonView='primaryShort'`
   - Дефолтная кнопка → `ButtonView='secondary'`

3. **ESnippet/Organic** (вкладка "Поиск"):
   - Кнопка "Купить в 1 клик" → `EButton_visible='true'`, `ButtonView='primaryShort'`
   - Без кнопки → `EButton_visible='false'`

---

## Chrome MCP команды для исследования

```javascript
// Найти все EOfferItem и проверить тип кнопки
Array.from(document.querySelectorAll('.EOfferItem')).map(el => ({
  shop: el.querySelector('.EOfferItem-ShopName')?.textContent?.trim(),
  btnClass: el.querySelector('.EOfferItem-Button')?.className,
  isWhite: el.querySelector('.Button_view_white') !== null,
  isCheckout: el.querySelector('[href*="/cart"]') !== null
}))

// Найти все EShopItem и проверить тип кнопки
Array.from(document.querySelectorAll('.EShopItem')).map(el => ({
  title: el.querySelector('.EShopItem-Title')?.textContent?.trim()?.substring(0, 30),
  hasCheckout: el.querySelector('.EMarketCheckoutButton') !== null,
  hasDefault: el.querySelector('.Button_view_default') !== null,
  withCheckoutMod: el.classList.contains('EShopItem_withCheckout')
}))

// Найти все Organic с кнопкой "Купить в 1 клик"
Array.from(document.querySelectorAll('[class*="Organic"]')).filter(el => 
  el.querySelector('[data-market-url-type="market_checkout"]')
).map(el => ({
  title: el.querySelector('.OrganicTitle')?.textContent?.trim()?.substring(0, 30),
  btnClass: el.querySelector('.MarketCheckout-Button')?.className
}))
```

---

## HTML-структура кнопок (для справки)

### Красная кнопка чекаута (primaryShort)
```html
<a class="Button Button_view_primary MarketCheckout-Button" 
   data-market-url-type="market_checkout"
   href="https://market.yandex.ru/my/cart?...">
  <span class="Button-Text">Купить в 1 клик</span>
</a>
```

### Белая кнопка "В магазин" (white)
```html
<a class="Button Button_view_white EOfferItem-Button" 
   href="https://shop.example.ru/...">
  В магазин
</a>
```

### Дефолтная кнопка (secondary)
```html
<a class="Button Button_view_default EShopItem-ButtonLink" 
   href="https://shop.example.ru/...">
  В магазин
</a>
```

---

## Связанные файлы

- @src/parsing-rules.ts — правила парсинга (v6)
- @src/utils/snippet-parser.ts — логика парсинга
- @src/component-handlers.ts — handleEButton() и другие обработчики
- @config/parsing-rules.json — JSON версия правил
- @examples/iphone17.html — тестовый HTML

---

## Тестовые файлы

- `examples/iphone17.html` — Organic с кнопкой "Купить в 1 клик"
- Нужен HTML с EOfferItem (попап "Цены в магазинах")
- Нужен HTML с EShopItem (вкладка "Товары")
