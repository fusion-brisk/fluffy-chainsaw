# Рефакторинг Этап 3: Тесты и очистка

## Контекст

После выполнения этапов 1 и 2 (`Refactor_Stage1_Quick_Wins`, `Refactor_Stage2_Split_Functions`) код значительно улучшился:
- Кэш оптимизирован (O(1) очистка)
- `processVariantProperty` сокращена с 275 до 60 строк
- Добавлены helper-функции для переиспользования
- Handlers мигрированы на новый API

## Цели этапа

1. Добавить unit-тесты для новых helper-функций
2. Проверить использование deprecated функций
3. Удалить deprecated функции (если не используются)
4. Финальная очистка кода

---

## Задача 1: Unit-тесты для helper-функций

### Файл: `tests/property-utils/helpers.test.ts`

Тестируемые функции (private, но можно протестировать через экспортируемые):

1. **`parseVariantSyntax`** — через `trySetVariantProperty`
2. **`normalizeVariantValue`** — через `processVariantProperty`
3. **`detectPropertyType`** — через `processVariantProperty`

### Тесты для `trySetProperty`:

```typescript
describe('trySetProperty', () => {
  it('should return false if property not found', () => {
    // Mock instance without properties
  });
  
  it('should try all property names until one works', () => {
    // Mock instance with 'View' property
    // Call trySetProperty with ['view', 'View', 'VIEW']
  });
  
  it('should track missing property on failure', () => {
    // Verify trackMissingProperty is called
  });
});
```

### Тесты для `trySetVariantProperty`:

```typescript
describe('trySetVariantProperty', () => {
  it('should parse PropertyName=value format', () => {
    // Call with ['View=large']
  });
  
  it('should return false on invalid format', () => {
    // Call with ['invalid']
  });
  
  it('should try fallback variants', () => {
    // Call with ['View=large', 'view=large']
  });
});
```

---

## Задача 2: Проверка использования deprecated функций

### Поиск вызовов:

```bash
grep -r "processBooleanProperty\|processStringProperty\|processVariantProperty\|processVariantPropertyRecursive" src/
```

### Ожидаемые результаты:

- `processBooleanProperty` — вызывается из `processVariantProperty` (internal)
- `processStringProperty` — вызывается из `label-handlers.ts`? Нужно проверить
- `processVariantProperty` — оставлена для обратной совместимости
- `processVariantPropertyRecursive` — оставлена для обратной совместимости

---

## Задача 3: Удаление неиспользуемых функций

Если функции действительно не используются извне, можно:
1. Сделать их `private` (убрать `export`)
2. Или полностью удалить

**ВАЖНО**: Сначала проверить все imports и использования!

---

## Задача 4: Финальная очистка

1. Убедиться, что все файлы форматированы (Prettier)
2. Проверить ESLint warnings
3. Проверить размер бандла (не увеличился ли)

---

## Чеклист

- [ ] Создать `tests/property-utils/helpers.test.ts`
- [ ] Добавить тесты для `trySetProperty`
- [ ] Добавить тесты для `trySetVariantProperty`
- [ ] Проверить вызовы deprecated функций в src/
- [ ] Удалить/приватизировать неиспользуемые deprecated функции
- [ ] Запустить `npm run lint` — без warnings
- [ ] Запустить `npm run test` — все тесты проходят
- [ ] Проверить размер `dist/code.js`

---

## Критерии успеха

1. Тесты покрывают основные сценарии
2. Deprecated функции удалены или приватизированы
3. Код чистый, без warnings
4. Регрессий нет (плагин работает)


