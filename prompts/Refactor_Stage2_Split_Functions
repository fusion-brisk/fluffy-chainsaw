# –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≠—Ç–∞–ø 2: –†–∞–∑–±–∏–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–∞ 1 (`Refactor_Stage1_Quick_Wins`) –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–∞–∑–±–∏–µ–Ω–∏—é —Å–ª–æ–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

**–ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞**: `processVariantProperty()` ‚Äî 275 —Å—Ç—Ä–æ–∫, –Ω–∞—Ä—É—à–∞–µ—Ç Single Responsibility Principle.

## –¶–µ–ª–∏ —ç—Ç–∞–ø–∞

1. –†–∞–∑–±–∏—Ç—å `processVariantProperty` –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
2. –í—ã–Ω–µ—Å—Ç–∏ –æ–±—â–∏–π helper –¥–ª—è try/catch –ø–∞—Ç—Ç–µ—Ä–Ω–∞
3. –î–æ–±–∞–≤–∏—Ç—å `trySetVariantPropertyRecursive()` –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ `label-handlers.ts`
4. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –≤—ã–∑–æ–≤—ã —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

## –ó–∞–¥–∞—á–∞ 1: Helper –¥–ª—è try/catch –ø–∞—Ç—Ç–µ—Ä–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞

–ü–∞—Ç—Ç–µ—Ä–Ω "try simpleKey ‚Üí catch ‚Üí try fullKey" –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 4+ —Ä–∞–∑–∞ –≤ –∫–æ–¥–µ:

```typescript
try {
  instance.setProperties({ [simpleKey]: value });
  return true;
} catch (e) {
  try {
    instance.setProperties({ [foundKey]: value });
    return true;
  } catch (e2) {
    return false;
  }
}
```

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –≤ `src/property-utils.ts` (–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 126, –ø–µ—Ä–µ–¥ "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏"):

```typescript
// ============================================================================
// Helper —Ñ—É–Ω–∫—Ü–∏–∏
// ============================================================================

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ —Å fallback –Ω–∞ –ø–æ–ª–Ω—ã–π –∫–ª—é—á.
 * –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ—Ç –ø—Ä–æ—Å—Ç–æ–µ –∏–º—è, –ø—Ä–∏ –æ—à–∏–±–∫–µ ‚Äî –ø–æ–ª–Ω—ã–π –∫–ª—é—á —Å ID.
 * 
 * @param instance –ò–Ω—Å—Ç–∞–Ω—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
 * @param simpleKey –ü—Ä–æ—Å—Ç–æ–µ –∏–º—è —Å–≤–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "View")
 * @param fullKey –ü–æ–ª–Ω—ã–π –∫–ª—é—á —Å ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, "View#12345:0")
 * @param value –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
 * @returns true –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ, false –ø—Ä–∏ –æ—à–∏–±–∫–µ
 */
function setPropertyWithFallback(
  instance: InstanceNode,
  simpleKey: string,
  fullKey: string,
  value: string | boolean
): boolean {
  try {
    instance.setProperties({ [simpleKey]: value });
    return true;
  } catch {
    if (fullKey !== simpleKey) {
      try {
        instance.setProperties({ [fullKey]: value });
        return true;
      } catch {
        // –û–±–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å
      }
    }
    return false;
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ `trySetProperty`:

```typescript
// –ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 169-183):
try {
  instance.setProperties({ [simpleKey]: value });
  Logger.debug(`   ‚úÖ [trySetProperty] ${simpleKey}=${value} (${fieldName})`);
  return true;
} catch (e) {
  try {
    instance.setProperties({ [foundKey]: value });
    Logger.debug(`   ‚úÖ [trySetProperty] ${foundKey}=${value} (${fieldName})`);
    return true;
  } catch (e2) {
    trackSetPropertyError(instance.name, simpleKey, String(value));
    return false;
  }
}

// –°—Ç–∞–ª–æ:
const success = setPropertyWithFallback(instance, simpleKey, foundKey, value);
if (success) {
  Logger.debug(`   ‚úÖ [trySetProperty] ${simpleKey}=${value} (${fieldName})`);
  return true;
} else {
  trackSetPropertyError(instance.name, simpleKey, String(value));
  return false;
}
```

---

## –ó–∞–¥–∞—á–∞ 2: –†–∞–∑–±–∏—Ç—å `processVariantProperty` –Ω–∞ —á–∞—Å—Ç–∏

### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (275 —Å—Ç—Ä–æ–∫, —Å—Ç—Ä–æ–∫–∏ 492-769):

```
processVariantProperty(instance, value, fieldName)
‚îú‚îÄ‚îÄ –ü–∞—Ä—Å–∏–Ω–≥ "PropName=value" (—Å—Ç—Ä–æ–∫–∏ 498-522)
‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ —Å–≤–æ–π—Å—Ç–≤–∞ –≤ –∫—ç—à–µ (—Å—Ç—Ä–æ–∫–∏ 530-537)
‚îú‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–≤–æ–π—Å—Ç–≤–∞ (—Å—Ç—Ä–æ–∫–∏ 549-577)
‚îÇ   ‚îú‚îÄ‚îÄ VARIANT —Å options
‚îÇ   ‚îú‚îÄ‚îÄ VARIANT –±–µ–∑ options (type === 'VARIANT')
‚îÇ   ‚îî‚îÄ‚îÄ BOOLEAN
‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ exposed property (—Å—Ç—Ä–æ–∫–∏ 589-604)
‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ VARIANT –±–µ–∑ options (—Å—Ç—Ä–æ–∫–∏ 606-688)
‚îÇ   ‚îú‚îÄ‚îÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: —Ç–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ
‚îÇ   ‚îú‚îÄ‚îÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1b: –ø–æ–ª–Ω—ã–π –∫–ª—é—á
‚îÇ   ‚îî‚îÄ‚îÄ –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: —Å–æ –≤—Å–µ–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
‚îú‚îÄ‚îÄ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 698-744)
‚îî‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∏ 751-764)
```

### –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–°–æ–∑–¥–∞—Ç—å 3 –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

#### 2.1. `parseVariantSyntax(value: string)`

```typescript
/**
 * –ü–∞—Ä—Å–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—Å "PropertyName=value"
 * @returns { propName, propValue } –∏–ª–∏ null –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
 */
function parseVariantSyntax(value: string): { propName: string; propValue: string } | null {
  if (!value || typeof value !== 'string') {
    return null;
  }
  
  const trimmed = value.trim();
  const match = trimmed.match(/^([^=]+?)\s*=\s*(.+)$/);
  
  if (!match || match.length < 3) {
    return null;
  }
  
  const propName = match[1].trim();
  const propValue = match[2].trim();
  
  if (!propName || !propValue) {
    return null;
  }
  
  return { propName, propValue };
}
```

#### 2.2. `detectPropertyType(property: ComponentPropertyValue)`

```typescript
type PropertyCategory = 'VARIANT_WITH_OPTIONS' | 'VARIANT_NO_OPTIONS' | 'BOOLEAN' | 'UNKNOWN';

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
 */
function detectPropertyType(property: unknown): PropertyCategory {
  if (!property || typeof property !== 'object') {
    return 'UNKNOWN';
  }
  
  const prop = property as Record<string, unknown>;
  const propType = prop.type;
  const hasOptions = 'options' in prop && Array.isArray(prop.options) && prop.options.length > 0;
  
  if (hasOptions) {
    return 'VARIANT_WITH_OPTIONS';
  }
  
  if (propType === 'VARIANT') {
    return 'VARIANT_NO_OPTIONS';
  }
  
  if ('value' in prop && typeof prop.value === 'boolean') {
    return 'BOOLEAN';
  }
  
  return 'UNKNOWN';
}
```

#### 2.3. `normalizeVariantValue(targetValue: string, options: readonly string[])`

```typescript
/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è VARIANT —Å–≤–æ–π—Å—Ç–≤–∞.
 * –ò—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ options —Å —É—á—ë—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ boolean-–∑–Ω–∞—á–µ–Ω–∏–π.
 * 
 * @returns –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ options –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
 */
function normalizeVariantValue(targetValue: string, options: readonly string[]): string | null {
  const targetLower = targetValue.toLowerCase();
  
  // 1. –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  for (const option of options) {
    if (option === targetValue) {
      return option;
    }
  }
  
  // 2. –ë–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
  for (const option of options) {
    if (option.toLowerCase() === targetLower) {
      return option;
    }
  }
  
  // 3. Boolean-–∑–Ω–∞—á–µ–Ω–∏—è (true/false –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏)
  if (targetLower === 'true' || targetLower === 'false') {
    for (const option of options) {
      const optLower = option.toLowerCase();
      if (optLower === targetLower ||
          (targetLower === 'true' && optLower === '1') ||
          (targetLower === 'false' && optLower === '0')) {
        return option;
      }
    }
  }
  
  return null;
}
```

### –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `processVariantProperty`

–ü–æ—Å–ª–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è helper-—Ñ—É–Ω–∫—Ü–∏–π, `processVariantProperty` —É–ø—Ä–æ—â–∞–µ—Ç—Å—è –¥–æ ~80 —Å—Ç—Ä–æ–∫:

```typescript
export function processVariantProperty(instance: InstanceNode, value: string, fieldName: string): boolean {
  try {
    Logger.debug(`üîç [Variant Property] "${instance.name}", –ø–æ–ª–µ "${fieldName}", –∑–Ω–∞—á–µ–Ω–∏–µ: "${value}"`);
    
    // 1. –ü–∞—Ä—Å–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
    const parsed = parseVariantSyntax(value);
    if (!parsed) {
      Logger.debug(`   ‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É PropertyName=value`);
      return false;
    }
    
    const { propName, propValue } = parsed;
    Logger.debug(`   üìù –†–∞—Å–ø–∞—Ä—Å–µ–Ω–æ: propName="${propName}", propValue="${propValue}"`);
    
    // 2. –ò—â–µ–º —Å–≤–æ–π—Å—Ç–≤–æ –≤ –∫—ç—à–µ
    if (!instance.componentProperties) {
      Logger.warn(`‚ö†Ô∏è –£ –∏–Ω—Å—Ç–∞–Ω—Å–∞ "${instance.name}" –Ω–µ—Ç componentProperties`);
      return false;
    }
    
    const foundKey = findPropertyKey(instance, propName);
    if (!foundKey) {
      trackMissingProperty(instance.name, propName, instance);
      return false;
    }
    
    const property = instance.componentProperties[foundKey];
    const simpleKey = foundKey.split('#')[0];
    
    // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–≤–æ–π—Å—Ç–≤–∞
    const category = detectPropertyType(property);
    Logger.debug(`   üìã –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–≤–æ–π—Å—Ç–≤–∞: ${category}`);
    
    switch (category) {
      case 'BOOLEAN':
        return processBooleanProperty(instance, propName, propValue, fieldName, foundKey);
        
      case 'VARIANT_NO_OPTIONS':
        return setVariantWithoutOptions(instance, simpleKey, foundKey, propValue, fieldName);
        
      case 'VARIANT_WITH_OPTIONS': {
        const options = (property as { options: readonly string[] }).options;
        return setVariantWithOptions(instance, simpleKey, foundKey, propValue, options, fieldName);
      }
        
      default:
        Logger.warn(`‚ö†Ô∏è Property "${propName}" –∏–º–µ–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø`);
        return false;
    }
  } catch (e) {
    Logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Variant Property –¥–ª—è "${fieldName}":`, e);
    return false;
  }
}
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ helper-—Ñ—É–Ω–∫—Ü–∏–∏

```typescript
/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç VARIANT —Å–≤–æ–π—Å—Ç–≤–æ –±–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö options.
 * –ü—Ä–æ–±—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: –ø—Ä–æ—Å—Ç–æ–π –∫–ª—é—á, –ø–æ–ª–Ω—ã–π –∫–ª—é—á, –≤—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞.
 */
function setVariantWithoutOptions(
  instance: InstanceNode,
  simpleKey: string,
  fullKey: string,
  value: string,
  fieldName: string
): boolean {
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: —Ç–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ
  if (setPropertyWithFallback(instance, simpleKey, fullKey, value)) {
    const updated = instance.componentProperties[fullKey];
    const updatedValue = updated && typeof updated === 'object' && 'value' in updated ? updated.value : null;
    if (String(updatedValue) === value) {
      Logger.debug(`   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ "${simpleKey}" = "${value}"`);
      return true;
    }
  }
  
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: —Å–æ –≤—Å–µ–º–∏ —Ç–µ–∫—É—â–∏–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
  const allProps = collectCurrentProperties(instance);
  allProps[simpleKey] = value;
  
  try {
    instance.setProperties(allProps);
    const updated = instance.componentProperties[fullKey];
    const updatedValue = updated && typeof updated === 'object' && 'value' in updated ? updated.value : null;
    if (String(updatedValue) === value) {
      Logger.debug(`   ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ –≤—Å–µ–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏: "${simpleKey}" = "${value}"`);
      return true;
    }
  } catch {
    // ignore
  }
  
  trackSetPropertyError(instance.name, simpleKey, value);
  return false;
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç VARIANT —Å–≤–æ–π—Å—Ç–≤–æ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –ø—Ä–æ—Ç–∏–≤ options.
 */
function setVariantWithOptions(
  instance: InstanceNode,
  simpleKey: string,
  fullKey: string,
  value: string,
  options: readonly string[],
  fieldName: string
): boolean {
  // Exposed property (–ø—É—Å—Ç—ã–µ options)
  if (options.length === 0) {
    if (setPropertyWithFallback(instance, simpleKey, fullKey, value)) {
      Logger.debug(`   ‚úÖ Exposed property "${simpleKey}" = "${value}"`);
      return true;
    }
    return false;
  }
  
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
  const normalized = normalizeVariantValue(value, options);
  if (!normalized) {
    Logger.warn(`‚ö†Ô∏è –ó–Ω–∞—á–µ–Ω–∏–µ "${value}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ options: [${options.join(', ')}]`);
    return false;
  }
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
  if (setPropertyWithFallback(instance, simpleKey, fullKey, normalized)) {
    Logger.debug(`   ‚úÖ Variant "${simpleKey}" = "${normalized}" (${fieldName})`);
    return true;
  }
  
  Logger.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å "${simpleKey}" = "${normalized}"`);
  return false;
}

/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–∞ –¥–ª—è batch-—É—Å—Ç–∞–Ω–æ–≤–∫–∏.
 */
function collectCurrentProperties(instance: InstanceNode): { [key: string]: string | boolean } {
  const result: { [key: string]: string | boolean } = {};
  const props = instance.componentProperties;
  
  for (const key in props) {
    if (!Object.prototype.hasOwnProperty.call(props, key)) continue;
    
    const prop = props[key];
    if (prop && typeof prop === 'object' && 'value' in prop) {
      const simpleName = key.split('#')[0];
      const value = prop.value;
      
      if (typeof value === 'string' || typeof value === 'boolean') {
        result[simpleName] = value;
      } else if (typeof value === 'number') {
        result[simpleName] = String(value);
      }
    }
  }
  
  return result;
}
```

---

## –ó–∞–¥–∞—á–∞ 3: `trySetVariantPropertyRecursive()`

### –ü—Ä–æ–±–ª–µ–º–∞

`label-handlers.ts` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `processVariantPropertyRecursive()`, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–∞ –≤ –Ω–æ–≤–æ–º API.

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ—Å–ª–µ `trySetVariantProperty`:

```typescript
/**
 * –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Variant Property –≤–æ –≤—Å–µ—Ö –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö.
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞.
 * 
 * @param node –ö–æ—Ä–Ω–µ–≤–æ–π —É–∑–µ–ª –¥–ª—è –æ–±—Ö–æ–¥–∞
 * @param propertyVariants –ú–∞—Å—Å–∏–≤ —Ñ–æ—Ä–º–∞—Ç–æ–≤ "PropertyName=value"
 * @param fieldName –ò–º—è –ø–æ–ª—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
 * @param allowedInstanceNames –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∞–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
 * @returns true –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–≤–æ–π—Å—Ç–≤–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
 */
export function trySetVariantPropertyRecursive(
  node: SceneNode,
  propertyVariants: string[],
  fieldName: string,
  allowedInstanceNames?: string[]
): boolean {
  if (node.removed) return false;
  
  let anySet = false;
  
  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —É–∑–µ–ª, –µ—Å–ª–∏ —ç—Ç–æ –∏–Ω—Å—Ç–∞–Ω—Å
  if (node.type === 'INSTANCE') {
    const instance = node as InstanceNode;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∏–º–µ–Ω–∏
    const shouldProcess = !allowedInstanceNames || 
                          allowedInstanceNames.length === 0 || 
                          allowedInstanceNames.includes(instance.name);
    
    if (shouldProcess) {
      const result = trySetVariantProperty(instance, propertyVariants, fieldName);
      anySet = anySet || result;
    }
  }
  
  // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏–º –¥–µ—Ç–µ–π
  if ('children' in node && node.children) {
    for (const child of node.children) {
      if (!child.removed) {
        const childResult = trySetVariantPropertyRecursive(child, propertyVariants, fieldName, allowedInstanceNames);
        anySet = anySet || childResult;
      }
    }
  }
  
  return anySet;
}
```

---

## –ó–∞–¥–∞—á–∞ 4: –ú–∏–≥—Ä–∞—Ü–∏—è `label-handlers.ts`

### –§–∞–π–ª: `src/handlers/label-handlers.ts`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –ò–º–ø–æ—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 11)

```typescript
// –ë—ã–ª–æ:
import { processVariantProperty, processStringProperty, processVariantPropertyRecursive, trySetProperty } from '../property-utils';

// –°—Ç–∞–ª–æ:
import { trySetProperty, trySetVariantProperty, trySetVariantPropertyRecursive } from '../property-utils';
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: `handleBrandLogic` (—Å—Ç—Ä–æ–∫–∏ 36, 45)

```typescript
// –ë—ã–ª–æ:
processVariantPropertyRecursive(containerInstance, 'Brand=false', '#Brand', SNIPPET_CONTAINER_NAMES);

// –°—Ç–∞–ª–æ:
trySetVariantPropertyRecursive(containerInstance, ['Brand=false'], '#Brand', SNIPPET_CONTAINER_NAMES);
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: `handleELabelGroup` (—Å—Ç—Ä–æ–∫–∏ 87, 92, 100-104)

```typescript
// –ë—ã–ª–æ:
processVariantProperty(eLabelGroupInstance, `${config.properties.rating.variantName}=true`, config.properties.rating.dataField);

// –°—Ç–∞–ª–æ:
trySetVariantProperty(eLabelGroupInstance, [`${config.properties.rating.variantName}=true`], config.properties.rating.dataField);
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 4: `handleEPriceBarometer` (—Å—Ç—Ä–æ–∫–∏ 130-135, 155-159)

```typescript
// –ë—ã–ª–æ:
processStringProperty(
  ePriceBarometerInstance,
  config.properties.view.variantName,
  viewVal,
  config.properties.view.dataField
);

// –°—Ç–∞–ª–æ:
trySetProperty(
  ePriceBarometerInstance,
  [config.properties.view.variantName],
  viewVal,
  config.properties.view.dataField
);

// –ë—ã–ª–æ:
processVariantProperty(
  ePriceBarometerInstance,
  `${config.properties.isCompact.variantName}=${isCompact}`,
  config.properties.isCompact.dataField
);

// –°—Ç–∞–ª–æ:
trySetVariantProperty(
  ePriceBarometerInstance,
  [`${config.properties.isCompact.variantName}=${isCompact}`],
  config.properties.isCompact.dataField
);
```

---

## –ó–∞–¥–∞—á–∞ 5: –ú–∏–≥—Ä–∞—Ü–∏—è `button-handlers.ts`

### –§–∞–π–ª: `src/handlers/button-handlers.ts`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ: —Å—Ç—Ä–æ–∫–∞ 179

```typescript
// –ë—ã–ª–æ:
processVariantProperty(childInstance, `${propName}=${hasButton}`, '#BUTTON');

// –°—Ç–∞–ª–æ:
trySetVariantProperty(childInstance, [`${propName}=${hasButton}`], '#BUTTON');
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ: –∏–º–ø–æ—Ä—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 8)

```typescript
// –ë—ã–ª–æ:
import { processVariantProperty, processStringProperty, trySetProperty, trySetVariantProperty } from '../property-utils';

// –°—Ç–∞–ª–æ:
import { trySetProperty, trySetVariantProperty } from '../property-utils';
```

---

## –ß–µ–∫–ª–∏—Å—Ç

### Helper —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å `setPropertyWithFallback()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `parseVariantSyntax()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `detectPropertyType()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `normalizeVariantValue()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `collectCurrentProperties()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `setVariantWithoutOptions()` –≤ `property-utils.ts`
- [ ] –î–æ–±–∞–≤–∏—Ç—å `setVariantWithOptions()` –≤ `property-utils.ts`

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å `processVariantProperty()` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º helper-—Ñ—É–Ω–∫—Ü–∏–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å `trySetVariantPropertyRecursive()` –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å

### –ú–∏–≥—Ä–∞—Ü–∏—è handlers
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `label-handlers.ts` –Ω–∞ –Ω–æ–≤—ã–π API
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å `button-handlers.ts` –Ω–∞ –Ω–æ–≤—ã–π API
- [ ] –£–±—Ä–∞—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–º–ø–æ—Ä—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞
- [ ] `npm run build` ‚Äî –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `npm run lint` ‚Äî –±–µ–∑ warnings
- [ ] –¢–µ—Å—Ç –ø–ª–∞–≥–∏–Ω–∞ ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

1. `processVariantProperty` —É–º–µ–Ω—å—à–µ–Ω–∞ —Å 275 –¥–æ ~80 —Å—Ç—Ä–æ–∫
2. Helper-—Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
3. –í—Å–µ handlers –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–π API (`trySet*` —Ñ—É–Ω–∫—Ü–∏–∏)
4. –ö–æ–¥ —á–∏—Ç–∞–µ–º—ã–π –∏ maintainable

---

## –°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ `Refactor_Stage3_Tests_Cleanup`:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ unit-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –£–¥–∞–ª–µ–Ω–∏–µ deprecated —Ñ—É–Ω–∫—Ü–∏–π (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
- –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞

