# Контекст: EProductSnippet — маппинг EShopItem и ESnippet

## Что сделано

Добавлена поддержка двух новых типов сниппетов Яндекс.Маркета:

### 1. EShopItem — сниппет магазина
Поля данных:
- `#OrganicTitle` ← `.EShopItem-Title`
- `#OrganicText` ← `.EShopItem-Description`
- `#OrganicImage` ← `.EShopItem-Image .EThumb-Image`
- `#ShopName` ← `.EShopItem-ShopName .EShopName`
- `#EBnpl` ← `.EShopItem-Bnpl` (BNPL блок: Сплит, Долями)
- `#EBnpl-Item-1..N` ← `.EBnpl .Line-AddonContent`

### 2. ESnippet (Organic_withOfferInfo) — органический сниппет
Новые поля:
- `#QuoteText` ← `.OrganicUgcReviews-Text`
- `#QuoteImage` ← `.OrganicUgcReviews img`
- `#Sitelinks` ← `.Sitelinks`
- `#Sitelinks-Item-1..N` ← `.Sitelinks-Title`
- `#Phone` ← `.CoveredPhone`
- `#Promo` ← `.PromoOffer`
- `#Address` ← `.Organic-Address`

### Обновлённые файлы
- `src/parsing-rules.ts` — добавлены селекторы для EShopItem и ESnippet
- `src/utils/snippet-parser.ts` — парсинг новых полей
- `src/utils/dom-utils.ts` — extractProductURL для EShopItem

## Что нужно сделать дальше

1. **Добавить обработчики в `component-handlers.ts`:**
   - `handleQuote()` — установка видимости и текста цитаты
   - `handleSitelinks()` — заполнение сайтлинков
   - `handlePhone()`, `handleAddress()`, `handlePromo()`
   - `handleEBnplGroup()` — BNPL блок в EShopItem

2. **Обновить `code.ts`:**
   - Вызов новых обработчиков
   - Поддержка контейнеров ESnippet в Figma

3. **Тестирование с реальными HTML:**
   - Проверить парсинг всех типов сниппетов
   - Сверить результаты с Figma-компонентами

## Работа с минимизированными HTML

HTML-файлы из Яндекса приходят **в одну строку** (435k+ токенов). Для анализа структуры используй Python:

```python
# Пример скрипта для анализа HTML
from bs4 import BeautifulSoup
import re

with open('путь/к/файлу.html', 'r', encoding='utf-8') as f:
    html = f.read()

soup = BeautifulSoup(html, 'html.parser')

# Найти все классы с нужным паттерном
for el in soup.select('[class*="EShopItem"]'):
    classes = el.get('class', [])
    print(f'Classes: {" ".join(classes)[:100]}')
```

Или через терминал:
```bash
# Найти все классы с паттерном
grep -o 'class="[^"]*ИмяКласса[^"]*"' файл.html | sort | uniq -c | sort -rn | head -20

# Контекст вокруг элемента
python3 -c "
import re
with open('файл.html', 'r') as f: html = f.read()
pos = html.find('ИмяКласса')
print(html[max(0,pos-500):pos+1000])
"
```

## MCP Figma Desktop

Для отладки маппинга используй Figma MCP:

```
mcp_Figma_Desktop_get_design_context — получить код компонента
mcp_Figma_Desktop_get_screenshot — скриншот для визуальной проверки
mcp_Figma_Desktop_get_metadata — структура нод (node-id)
```

### Пример: проверить структуру компонента
1. Пользователь выделяет инстанс в Figma
2. Вызов `get_design_context` → получаем Props компонента
3. Сопоставляем Props с полями данных из HTML

## Архитектура маппинга

```
HTML (парсинг)              Figma (применение)
─────────────────           ─────────────────────
snippet-parser.ts           component-handlers.ts
      ↓                            ↓
   CSVRow                    HandlerContext
      ↓                            ↓
row['#Field']        →      instance.setProperty('Field', value)
```

### Boolean свойства Figma-компонентов

| Компонент | Свойства |
|-----------|----------|
| `ESnippet` | `ratingReview`, `quote`, `delivery`, `bnpl`, `sitelinks`, `promo`, `contacts`, `address`, `priceBlock` |
| `EShopItem` | через Code Connect (внешняя либа) |
| `ELabelGroup` | `barometer`, `rating`, `checkout` |
| `EPriceBarometer` | `view: in-market/below-market/above-market` |

## Ключевые технические детали

- **ES5 target** — итоговый `dist/code.js` должен быть ES5
- **Сортировка контейнеров** — по визуальной позиции (Y→X)
- **Логирование** — через `Logger.info/debug/warn/error`
- **Поиск инстансов** — `findInstanceByName(container, 'ComponentName')`
- **Применение свойств** — `processVariantProperty`, `processStringProperty`, `processBooleanProperty`

## Селекторы в parsing-rules.ts

Формат правила:
```typescript
'FieldName': {
    domSelectors: ['.Class1', '[class*="Class2"]'],
    jsonKeys: ['key1', 'key2'],
    type: 'text' | 'boolean' | 'image' | 'price'
}
```

Доступ в snippet-parser.ts:
```typescript
const selectors = rules['FieldName']?.domSelectors || ['.fallback'];
const element = queryFirstMatch(cache, selectors);
```

